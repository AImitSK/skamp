rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    // Prüft ob User authentifiziert ist
    function isAuthenticated() {
      return request.auth != null;
    }

    // Prüft ob User SuperAdmin ist (für Cron Jobs und Admin-Funktionen)
    function isSuperAdmin() {
      return request.auth != null
             && (request.auth.token.organizationId == "superadmin-org"
                 || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == "superadmin-org");
    }

    // Prüft ob User zur Organisation gehört
    function belongsToOrg(orgId) {
      return request.auth != null
             && request.auth.token.organizationId == orgId;
    }

    // ========================================
    // GLOBALE JOURNALISTEN (Enhanced CRM)
    // ========================================

    // Globale Kontakte - Nur SuperAdmin (für Cron Jobs & Admin)
    match /contacts_enhanced/{contactId} {
      allow read, write: if isSuperAdmin();
    }

    // ========================================
    // JOURNALIST REFERENCES
    // ========================================

    // References - Org-Mitglieder oder SuperAdmin
    match /organizations/{orgId}/journalist_references/{referenceId} {
      allow read: if belongsToOrg(orgId) || isSuperAdmin();
      allow create: if belongsToOrg(orgId) || isSuperAdmin();
      allow update: if belongsToOrg(orgId) || isSuperAdmin();
      allow delete: if belongsToOrg(orgId) || isSuperAdmin();
    }

    // ========================================
    // MATCHING SYSTEM
    // ========================================

    // Matching-Kandidaten - Nur SuperAdmin (Cron Jobs)
    match /matching_candidates/{candidateId} {
      allow read, write: if isSuperAdmin();
    }

    // Matching Scan-Jobs - Nur SuperAdmin (Cron Jobs)
    match /matching_scan_jobs/{jobId} {
      allow read, write: if isSuperAdmin();
    }

    // System Settings - Lesen: Auth, Schreiben: SuperAdmin
    match /system_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ========================================
    // ORGANIZATIONS
    // ========================================

    // Organizations Root - Lesen: Alle Auth, Schreiben: Org-Member oder SuperAdmin
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if belongsToOrg(orgId) || isSuperAdmin();
    }

    // Organizations Sub-Collections - Org-Member oder SuperAdmin
    match /organizations/{orgId}/{collection}/{docId} {
      allow read: if belongsToOrg(orgId) || isSuperAdmin();
      allow write: if belongsToOrg(orgId) || isSuperAdmin();
    }

    // Organizations Deep Sub-Collections (z.B. contacts_enhanced)
    match /organizations/{orgId}/{collection}/{docId}/{subcollection}/{subdocId} {
      allow read: if belongsToOrg(orgId) || isSuperAdmin();
      allow write: if belongsToOrg(orgId) || isSuperAdmin();
    }

    // ========================================
    // PUBLICATIONS & MEDIA
    // ========================================

    // Publikationen in der Bibliothek - Lesen: Alle, Schreiben: SuperAdmin
    match /publications/{pubId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // SuperAdmin Publications - Nur SuperAdmin
    match /superadmin_publications/{pubId} {
      allow read, write: if isSuperAdmin();
    }

    // Companies Enhanced - Lesen: Alle, Schreiben: SuperAdmin
    match /companies_enhanced/{companyId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ========================================
    // LEGACY COLLECTIONS
    // ========================================

    // Legacy Companies - Org-basiert oder SuperAdmin
    match /companies/{companyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Legacy Contacts - Org-basiert oder SuperAdmin
    match /contacts/{contactId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Tags - User-basiert
    match /tags/{tagId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ========================================
    // USER DATA
    // ========================================

    // Users Collection - Nur eigener User oder SuperAdmin
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isSuperAdmin();
      allow write: if request.auth.uid == userId || isSuperAdmin();
    }

    // ========================================
    // MONITORING SYSTEM
    // ========================================

    // Campaign Monitoring Trackers
    match /campaign_monitoring_trackers/{trackerId} {
      allow read: if isAuthenticated()
                  && (resource.data.organizationId == request.auth.token.organizationId
                      || isSuperAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
                    && resource.data.organizationId == request.auth.token.organizationId;
    }

    // Monitoring Suggestions
    match /monitoring_suggestions/{suggestionId} {
      allow read: if isAuthenticated()
                  && resource.data.organizationId == request.auth.token.organizationId;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
                    && resource.data.organizationId == request.auth.token.organizationId;
    }

    // Spam Patterns
    match /spam_patterns/{patternId} {
      allow read: if isAuthenticated()
                  && resource.data.organizationId == request.auth.token.organizationId;
      allow create, update, delete: if isAuthenticated()
                                    && resource.data.organizationId == request.auth.token.organizationId;
    }

    // ========================================
    // DEFAULT FALLBACK
    // ========================================

    // Fallback: Nur authenticated users
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
