<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyVisual Debug Test</title>
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .aspect-16-9 {
            aspect-ratio: 16 / 9;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .object-cover { object-fit: cover; }
        .rounded-lg { border-radius: 8px; }
        .debug-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .debug-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
        }
        .debug-button:hover {
            background: #2563eb;
        }
        .log-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>KeyVisual CORS Debug Test</h1>
        
        <div class="debug-info">
            <h3>Test-Szenario:</h3>
            <p>Diese Seite simuliert das KeyVisual Element wie es in der Campaign Detail Page erscheint.</p>
            <p>URL: <span id="image-url"></span></p>
        </div>

        <!-- KeyVisual Element (genau wie in Campaign Detail Page) -->
        <div class="aspect-16-9">
            <img 
                id="keyvisual-image"
                src="https://firebasestorage.googleapis.com/v0/b/skamp-dev.appspot.com/o/test-image.jpg?alt=media&token=test-token"
                alt="Key Visual" 
                class="w-full h-full object-cover"
            />
        </div>

        <div class="debug-info">
            <h3>Debug Aktionen:</h3>
            <button class="debug-button" onclick="analyzeDOM()">1. DOM Analysieren</button>
            <button class="debug-button" onclick="testExtraction()">2. KeyVisual Extraktion Testen</button>
            <button class="debug-button" onclick="testCORSStrategies()">3. CORS Strategien Testen</button>
            <button class="debug-button" onclick="clearLog()">Log Löschen</button>
        </div>

        <div class="log-output" id="debug-log">
            Klicke auf "DOM Analysieren" um zu starten...
        </div>
    </div>

    <script>
        // Test Image URL (ersetze mit echter Firebase URL zum Testen)
        const TEST_IMAGE_URL = 'https://firebasestorage.googleapis.com/v0/b/skamp-dev.appspot.com/o/organizations%2Ftest%2Fmedia%2F1234567890-test-key-visual.jpg?alt=media&token=test-token-123';
        
        // Update image URL
        document.getElementById('keyvisual-image').src = TEST_IMAGE_URL;
        document.getElementById('image-url').textContent = TEST_IMAGE_URL;

        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        function analyzeDOM() {
            log('🔍 === DOM ANALYSE START ===');
            
            // Alle Bilder finden
            const allImages = document.querySelectorAll('img');
            log(`📊 Gefunden: ${allImages.length} img-Elemente im DOM`);
            
            // Detaillierte Analyse jedes Bildes
            allImages.forEach((img, index) => {
                log(`📷 Bild ${index + 1}:`);
                log(`   src: ${img.src}`);
                log(`   alt: ${img.alt}`);
                log(`   complete: ${img.complete}`);
                log(`   naturalWidth: ${img.naturalWidth}`);
                log(`   naturalHeight: ${img.naturalHeight}`);
                log(`   className: ${img.className}`);
                log(`   crossOrigin: ${img.crossOrigin}`);
                log(`   parent className: ${img.parentElement?.className}`);
                log('');
            });

            // Test spezifische Selektoren
            const selectors = [
                '.aspect-16-9 img',
                'img.w-full.h-full.object-cover', 
                'img[alt="Key Visual"]',
                'img.object-cover',
                '.rounded-lg img'
            ];

            log('🎯 Teste spezifische Selektoren:');
            selectors.forEach(selector => {
                try {
                    const elements = document.querySelectorAll(selector);
                    log(`   "${selector}": ${elements.length} Elemente`);
                } catch (e) {
                    log(`   "${selector}": FEHLER - ${e.message}`);
                }
            });
        }

        async function testExtraction() {
            log('🎨 === KEYVISUAL EXTRAKTION TEST ===');
            
            const targetImage = document.getElementById('keyvisual-image');
            if (!targetImage) {
                log('❌ KeyVisual Image nicht gefunden!');
                return;
            }

            log(`✅ KeyVisual gefunden: ${targetImage.src}`);
            
            // Warte bis Bild geladen ist
            if (!targetImage.complete) {
                log('⏳ Warte auf Bildladung...');
                await new Promise(resolve => {
                    targetImage.onload = resolve;
                    targetImage.onerror = () => {
                        log('❌ Bild konnte nicht geladen werden');
                        resolve();
                    };
                });
            }

            if (!targetImage.complete) {
                log('❌ Bild ist immer noch nicht geladen');
                return;
            }

            // Canvas erstellen
            log('🎨 Erstelle Canvas...');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = targetImage.naturalWidth || 800;
            canvas.height = targetImage.naturalHeight || 600;
            
            log(`📐 Canvas: ${canvas.width}x${canvas.height}`);

            // Test direktes Zeichnen
            try {
                log('🔄 Teste direktes Canvas-Zeichnen...');
                ctx.drawImage(targetImage, 0, 0);
                const testData = canvas.toDataURL('image/jpeg', 0.1);
                if (testData && testData.length > 100) {
                    log('✅ Direktes Zeichnen erfolgreich!');
                    log(`   Base64 Länge: ${testData.length}`);
                } else {
                    throw new Error('Canvas-Daten zu kurz oder leer');
                }
            } catch (error) {
                log(`❌ Direktes Zeichnen fehlgeschlagen: ${error.message}`);
                
                // Test CORS-Strategien
                await testCORSStrategies();
            }
        }

        async function testCORSStrategies() {
            log('🌐 === CORS STRATEGIEN TEST ===');
            
            const targetImage = document.getElementById('keyvisual-image');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = 600;

            // Strategie 1: CORS Image
            try {
                log('🔄 Strategie 1: CORS Anonymous Image...');
                const corsImage = new Image();
                corsImage.crossOrigin = 'anonymous';
                
                await new Promise((resolve, reject) => {
                    corsImage.onload = () => {
                        log('✅ CORS Image geladen');
                        resolve();
                    };
                    corsImage.onerror = (err) => {
                        log(`❌ CORS Image Fehler: ${err}`);
                        reject(err);
                    };
                    corsImage.src = targetImage.src;
                });

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(corsImage, 0, 0, canvas.width, canvas.height);
                
                const testData = canvas.toDataURL('image/jpeg', 0.1);
                if (testData && testData.length > 100) {
                    log('✅ CORS Strategie erfolgreich!');
                    return;
                }
            } catch (error) {
                log(`⚠️ CORS Strategie fehlgeschlagen: ${error.message}`);
            }

            // Strategie 2: Fetch + Blob
            try {
                log('🔄 Strategie 2: Fetch + Blob...');
                const response = await fetch(targetImage.src, { mode: 'cors' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                
                const blobImage = new Image();
                await new Promise((resolve, reject) => {
                    blobImage.onload = resolve;
                    blobImage.onerror = reject;
                    blobImage.src = blobUrl;
                });

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(blobImage, 0, 0, canvas.width, canvas.height);
                
                URL.revokeObjectURL(blobUrl);
                
                const testData = canvas.toDataURL('image/jpeg', 0.1);
                if (testData && testData.length > 100) {
                    log('✅ Fetch+Blob Strategie erfolgreich!');
                    return;
                }
            } catch (error) {
                log(`⚠️ Fetch+Blob Strategie fehlgeschlagen: ${error.message}`);
            }

            // Strategie 3: Proxy Route
            try {
                log('🔄 Strategie 3: Proxy Route...');
                const proxyUrl = `/api/proxy-firebase-image?url=${encodeURIComponent(targetImage.src)}`;
                log(`   Proxy URL: ${proxyUrl}`);
                
                const proxyResponse = await fetch(proxyUrl);
                if (!proxyResponse.ok) {
                    throw new Error(`Proxy failed: ${proxyResponse.status}`);
                }
                
                const proxyBlob = await proxyResponse.blob();
                const proxyBlobUrl = URL.createObjectURL(proxyBlob);
                
                const proxyImage = new Image();
                await new Promise((resolve, reject) => {
                    proxyImage.onload = resolve;
                    proxyImage.onerror = reject;
                    proxyImage.src = proxyBlobUrl;
                });

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(proxyImage, 0, 0, canvas.width, canvas.height);
                
                URL.revokeObjectURL(proxyBlobUrl);
                
                const testData = canvas.toDataURL('image/jpeg', 0.1);
                if (testData && testData.length > 100) {
                    log('🎉 Proxy Strategie erfolgreich! Das ist die Lösung!');
                    return;
                }
            } catch (error) {
                log(`⚠️ Proxy Strategie fehlgeschlagen: ${error.message}`);
                log('   Hinweis: Proxy Route funktioniert nur in Next.js App, nicht in dieser Test-Datei');
            }

            log('❌ Alle CORS-Strategien fehlgeschlagen');
        }
    </script>
</body>
</html>