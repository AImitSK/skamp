name: Check Overdue Notifications

on:
  # Zeitplan: Jede Stunde
  schedule:
    - cron: '0 * * * *'  # Minute 0 jeder Stunde
  
  # Manueller Trigger fÃ¼r Tests
  workflow_dispatch:
    inputs:
      debug:
        description: 'Debug-Modus aktivieren'
        required: false
        default: 'false'

jobs:
  check-notifications:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Timeout nach 5 Minuten
    
    steps:
      - name: Check overdue items
        id: cron
        env:
          API_URL: ${{ secrets.API_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "ğŸ• Starting notification check at $(date)"
          
          # Validierung ohne direkte secret-Referenzen
          if [ -z "${API_URL}" ]; then
            echo "âŒ Error: API_URL secret is not set"
            echo "Please add API_URL to your repository secrets"
            exit 1
          fi
          
          if [ -z "${CRON_SECRET}" ]; then
            echo "âŒ Error: CRON_SECRET secret is not set"
            echo "Please add CRON_SECRET to your repository secrets"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
          
          # API Call mit Fehlerbehandlung
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${API_URL}/api/cron/check-notifications" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            -m 300)  # 5 Minuten Timeout
          
          # Response und HTTP Code trennen
          body=$(echo "$response" | sed '$d')
          http_code=$(echo "$response" | tail -n1 | cut -d: -f2)
          
          # Debug-Ausgabe wenn aktiviert
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            echo "ğŸ“ Response body: $body"
            echo "ğŸ“Š HTTP code: $http_code"
          fi
          
          # PrÃ¼fe ob erfolgreich
          if [ "$http_code" = "200" ]; then
            echo "âœ… Notification check completed successfully"
            echo "ğŸ“„ Response: $body"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Notification check failed with status code $http_code"
            echo "ğŸ“„ Error response: $body"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Log success
        if: steps.cron.outputs.status == 'success'
        run: |
          echo "âœ… All notification checks completed"
          echo "ğŸ“… Next run scheduled in 1 hour"
      
      - name: Log failure
        if: failure()
        run: |
          echo "âŒ Notification check failed"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ’¡ Common issues:"
          echo "   - Wrong API_URL or CRON_SECRET"
          echo "   - API endpoint not accessible"
          echo "   - Authentication failed"
          echo ""
          echo "ğŸ“‹ Setup checklist:"
          echo "   1. Go to Settings â†’ Secrets â†’ Actions"
          echo "   2. Add API_URL (e.g., https://your-app.vercel.app)"
          echo "   3. Add CRON_SECRET (generate with: openssl rand -base64 32)"
          echo "   4. Ensure the same CRON_SECRET is set in Vercel env vars"